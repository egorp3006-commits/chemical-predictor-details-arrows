<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Таблиця — баланс реакції з векторами</title>
  <style>
    :root { --accent: #2a9df4; --pos: #1e6ed1; --neg: #d13b3b; --border: #9aa; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #f6f9fc; font-family: Arial, sans-serif; padding: 20px; }

    .container { max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .section { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    .title { font-weight: 700; font-size: 18px; margin-bottom: 15px; color: #333; }

    table.chem { border-collapse: collapse; width: 100%; }
    table.chem th, table.chem td { border: 1px solid var(--border); padding: 8px; text-align: center; background: #fff; font-size: 13px; }
    table.chem th { background: #e6f0fb; font-weight: 700; }
    .elem-cell { background: #fafafa; font-weight: 600; min-width: 40px; }
    
    input.num { width: 50px; border: 0; text-align: center; font-size: 13px; padding: 4px; background: transparent; }
    input.num:focus { outline: 1px solid var(--accent); background: #eef7ff; }
    
    .axis-checkbox { width: 18px; height: 18px; cursor: pointer; }
    .axis-col { width: 50px; }
    .mol-header { text-align: center; font-weight: 600; font-size: 13px; }
    
    canvas { border: 1px solid #ddd; background: #fafafa; display: block; margin-top: 10px; }

    @media (max-width: 1200px) { .container { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<div class="container">
  <!-- ТАБЛИЦЯ -->
  <div class="section">
    <div class="title">Вибір осей X та Y</div>
    <table class="chem" id="mainTable">
      <thead>
        <tr>
          <th>Елемент</th>
          <th class="axis-col">X</th>
          <th class="axis-col">Y</th>
          <th colspan="3">Реагенти</th>
          <th colspan="5">Продукти</th>
        </tr>
        <tr id="moleculeHeaders"></tr>
      </thead>
      <tbody id="elementsBody"></tbody>
    </table>
  </div>

  <!-- КАНВАС -->
  <div class="section">
    <div class="title">Векторна сітка</div>
    <canvas id="canvas" width="500" height="500"></canvas>
    <div style="font-size: 12px; color: #666; margin-top: 8px;">
      Вибери елементи як X та Y, введи індекси молекул, налаштуй коефіцієнти — вектори малюються автоматично.
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const elements = ["H", "C", "O", "N", "P", "S", "F", "Na", "Ca"];
  const reactants = [
    {id: "h2o", label: "H2O"},
    {id: "co2", label: "CO2"},
    {id: "o2", label: "O2"}
  ];
  const products = [
    {id: "h2", label: "H2"},
    {id: "o3", label: "O3"},
    {id: "h2co3", label: "H2CO3"},
    {id: "n2", label: "N2"},
    {id: "nh3", label: "NH3"}
  ];

  function defaultIndex(mol, elem) {
    const map = {
      h2o: {H: 2, O: 1},
      co2: {C: 1, O: 2},
      o2: {O: 2},
      h2: {H: 2},
      o3: {O: 3},
      h2co3: {H: 2, C: 1, O: 3},
      n2: {N: 2},
      nh3: {N: 1, H: 3}
    };
    return (map[mol] && map[mol][elem]) ? map[mol][elem] : 0;
  }

  // Заголовки молекул
  const headerRow = document.getElementById("moleculeHeaders");
  [...reactants, ...products].forEach(m => {
    const th = document.createElement("th");
    th.className = "mol-header";
    th.setAttribute("data-mol", m.id);
    th.innerHTML = `
      <div>${m.label}</div>
      <div style="font-size: 11px; color: #666;">Коеф:</div>
      <input class="num coef" data-mol="${m.id}" type="number" min="0" value="1" style="width: 45px;">
    `;
    headerRow.appendChild(th);
  });

  // Тіло таблиці
  const body = document.getElementById("elementsBody");
  elements.forEach(elem => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="elem-cell">${elem}</td>`;

    // Чекбокси для осей
    tr.innerHTML += `
      <td class="axis-col"><input type="checkbox" class="axis-checkbox axis-x" data-elem="${elem}"></td>
      <td class="axis-col"><input type="checkbox" class="axis-checkbox axis-y" data-elem="${elem}"></td>
    `;

    // Реагенти
    reactants.forEach(m => {
      const td = document.createElement("td");
      td.innerHTML = `<input class="num cell-left" data-mol="${m.id}" data-elem="${elem}" type="number" value="${defaultIndex(m.id, elem)}" min="0">`;
      tr.appendChild(td);
    });

    // Продукти
    products.forEach(m => {
      const td = document.createElement("td");
      td.innerHTML = `<input class="num cell-right" data-mol="${m.id}" data-elem="${elem}" type="number" value="${defaultIndex(m.id, elem)}" min="0">`;
      tr.appendChild(td);
    });

    body.appendChild(tr);
  });

  // Отримати вибрані осі
  function getAxes() {
    const xElem =document.querySelector(".axis-x:checked")?.getAttribute("data-elem");
    const yElem = document.querySelector(".axis-y:checked")?.getAttribute("data-elem");
    return {x: xElem, y: yElem};
  }

  // Обчислити баланс
  function calculateBalance() {
    const coefs = {};
    document.querySelectorAll(".coef").forEach(inp => {
      coefs[inp.getAttribute("data-mol")] = parseFloat(inp.value) || 0;
    });

    const matrix = [];
    elements.forEach(elem => {
      const row = [];
      [...reactants, ...products].forEach(m => {
        const idx = parseFloat(document.querySelector(`.cell-left[data-mol="${m.id}"][data-elem="${elem}"], .cell-right[data-mol="${m.id}"][data-elem="${elem}"]`)?.value) || 0;
        const sign = reactants.some(r => r.id === m.id) ? 1 : -1;
        row.push(idx * sign * coefs[m.id]);
      });
      matrix.push(row);
    });

    return matrix;
  }

  // Побудувати графік
  function plotGraph() {
    const axes = getAxes();
    if (!axes.x || !axes.y) {
      alert("Please select both X and Y axes");
      return;
    }

    const matrix = calculateBalance();
    const xIdx = elements.indexOf(axes.x);
    const yIdx = elements.indexOf(axes.y);

    const data = matrix.map(row => ({
      x: row[xIdx],
      y: row[yIdx]
    }));

    const ctx = document.getElementById("balanceChart").getContext("2d");
    if (window.chartInstance) {
      window.chartInstance.destroy();
    }

    window.chartInstance = new Chart(ctx, {
      type: "scatter",
      data: {
        datasets: [{
          label: `${axes.x} vs ${axes.y}`,
          data: data,
          backgroundColor: "rgba(75, 192, 192, 0.6)",
          borderColor: "rgba(75, 192, 192, 1)",
          borderWidth: 2,
          pointRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true }
        },
        scales: {
          x: { title: { display: true, text: axes.x } },
          y: { title: { display: true, text: axes.y } }
        }
      }
    });
  }

  document.getElementById("plotBtn").addEventListener("click", plotGraph);

  // Оновити баланс у реальному часі
  document.querySelectorAll(".num").forEach(inp => {
    inp.addEventListener("change", () => {
      const balance = calculateBalance();
      console.log("Balance matrix:", balance);
    });
  });
</script>

</body>